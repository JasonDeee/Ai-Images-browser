<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Image3 API - Photo Gallery</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      h1 {
        text-align: center;
        color: white;
        margin-bottom: 30px;
        font-size: 2.5em;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .loading {
        text-align: center;
        color: white;
        font-size: 1.5em;
        padding: 50px;
      }

      .category {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .category-title {
        font-size: 2em;
        color: #667eea;
        margin-bottom: 20px;
        border-bottom: 3px solid #667eea;
        padding-bottom: 10px;
      }

      .section {
        margin-bottom: 30px;
      }

      .section-title {
        font-size: 1.5em;
        color: #764ba2;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .section-prompt {
        font-size: 0.9em;
        color: #666;
        font-style: italic;
        margin-bottom: 15px;
        padding: 10px;
        background: #f5f5f5;
        border-radius: 5px;
      }

      .gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
      }

      .gallery-item {
        position: relative;
        border-radius: 10px;
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .gallery-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
      }

      .gallery-item img {
        width: 100%;
        height: 300px;
        object-fit: cover;
        display: block;
      }

      .gallery-item-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
        color: white;
        padding: 15px;
        transform: translateY(100%);
        transition: transform 0.3s ease;
      }

      .gallery-item:hover .gallery-item-overlay {
        transform: translateY(0);
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .modal-content {
        background-color: white;
        margin: 2% auto;
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s;
      }

      .close:hover {
        color: #000;
      }

      .modal-title {
        font-size: 1.8em;
        color: #667eea;
        margin-bottom: 20px;
        clear: both;
      }

      .preview-image {
        width: 100%;
        max-height: 300px;
        object-fit: contain;
        border-radius: 10px;
        margin-bottom: 20px;
        border: 2px solid #667eea;
      }

      .upload-section {
        margin: 20px 0;
      }

      .upload-label {
        display: block;
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
      }

      .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
        width: 100%;
      }

      .file-input-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1em;
        width: 100%;
        transition: transform 0.2s;
      }

      .file-input-button:hover {
        transform: scale(1.02);
      }

      .file-input-wrapper input[type="file"] {
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        cursor: pointer;
        width: 100%;
        height: 100%;
      }

      .user-image-preview {
        width: 100%;
        max-height: 300px;
        object-fit: contain;
        border-radius: 10px;
        margin-top: 15px;
        border: 2px solid #764ba2;
      }

      .caption-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1em;
        margin-top: 10px;
        transition: border-color 0.3s;
      }

      .caption-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .submit-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 30px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.1em;
        width: 100%;
        margin-top: 20px;
        transition: transform 0.2s;
        font-weight: bold;
      }

      .submit-button:hover:not(:disabled) {
        transform: scale(1.02);
      }

      .submit-button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .status-message {
        margin-top: 15px;
        padding: 12px;
        border-radius: 8px;
        text-align: center;
        font-weight: bold;
      }

      .status-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status-loading {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .result-image {
        width: 100%;
        max-height: 400px;
        object-fit: contain;
        border-radius: 10px;
        margin-top: 15px;
        border: 2px solid #28a745;
      }

      .info-box {
        background: #e7f3ff;
        border-left: 4px solid #667eea;
        padding: 15px;
        margin: 15px 0;
        border-radius: 5px;
      }

      .info-box strong {
        color: #667eea;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üé® Image3 API - Photo Gallery</h1>
      <div id="loading" class="loading">Loading gallery...</div>
      <div id="gallery-container"></div>
    </div>

    <!-- Modal -->
    <div id="uploadModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2 class="modal-title">Upload Your Photo</h2>

        <div class="info-box">
          <strong>Selected Template:</strong>
          <div id="selectedInfo"></div>
        </div>

        <img
          id="previewImage"
          class="preview-image"
          src=""
          alt="Template Preview"
        />

        <div class="upload-section">
          <label class="upload-label">Upload Your Photo:</label>
          <div class="file-input-wrapper">
            <button class="file-input-button">Choose File</button>
            <input type="file" id="userImageInput" accept="image/*" />
          </div>
          <img
            id="userImagePreview"
            class="user-image-preview"
            style="display: none"
          />
        </div>

        <div class="upload-section">
          <label class="upload-label"
            >Caption (describe changes you want):</label
          >
          <textarea
            id="captionInput"
            class="caption-input"
            rows="3"
            placeholder="Example: I want purple hair and glasses"
          ></textarea>
        </div>

        <button id="submitButton" class="submit-button">Generate Image</button>

        <div id="statusMessage"></div>
        <img id="resultImage" class="result-image" style="display: none" />
      </div>
    </div>

    <script>
      // Configuration
      const API_URL = "https://pic88.top";
      const DATA_URL = "https://clxteam.github.io/photo_gallery_data.json";

      // API Credentials - REPLACE WITH YOUR ACTUAL VALUES
      const API_KEY = "wellyzz135_demo_api_key_2023";
      const IMAGE3_SECRET_KEY = "image3_signature_secret_key_2024!@#";

      let selectedItem = null;
      let userImageFile = null;
      let userImageBase64 = null;

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        loadGallery();
        setupModal();
      });

      // Load gallery data
      async function loadGallery() {
        try {
          const response = await fetch(DATA_URL);
          const data = await response.json();

          document.getElementById("loading").style.display = "none";
          renderGallery(data);
        } catch (error) {
          document.getElementById(
            "loading"
          ).innerHTML = `<div style="color: #ff6b6b;">Error loading gallery: ${error.message}</div>`;
        }
      }

      // Render gallery
      function renderGallery(data) {
        const container = document.getElementById("gallery-container");

        data.categories.forEach((category) => {
          const categoryDiv = document.createElement("div");
          categoryDiv.className = "category";

          let categoryHTML = `<h2 class="category-title">${category.name}</h2>`;

          category.sections.forEach((section) => {
            categoryHTML += `
                        <div class="section">
                            <h3 class="section-title">üì∏ ${section.title}</h3>
                            <div class="section-prompt">${section.prompt}</div>
                            <div class="gallery">
                    `;

            section.items.forEach((item) => {
              categoryHTML += `
                            <div class="gallery-item" onclick="openModal('${item.id}', '${item.image_link}', '${section.title}', '${category.name}', '${section.prompt}')">
                                <img src="${item.image_link}" alt="${item.id}">
                                <div class="gallery-item-overlay">
                                    <div>${item.id}</div>
                                </div>
                            </div>
                        `;
            });

            categoryHTML += `
                            </div>
                        </div>
                    `;
          });

          categoryDiv.innerHTML = categoryHTML;
          container.appendChild(categoryDiv);
        });
      }

      // Setup modal
      function setupModal() {
        const modal = document.getElementById("uploadModal");
        const closeBtn = document.querySelector(".close");
        const fileInput = document.getElementById("userImageInput");
        const submitBtn = document.getElementById("submitButton");

        closeBtn.onclick = () => (modal.style.display = "none");

        window.onclick = (event) => {
          if (event.target === modal) {
            modal.style.display = "none";
          }
        };

        fileInput.onchange = handleFileSelect;
        submitBtn.onclick = handleSubmit;
      }

      // Open modal
      function openModal(id, imageLink, sectionTitle, categoryName, prompt) {
        selectedItem = { id, imageLink, sectionTitle, categoryName, prompt };

        document.getElementById("selectedInfo").innerHTML = `
                <div><strong>ID:</strong> ${id}</div>
                <div><strong>Category:</strong> ${categoryName}</div>
                <div><strong>Section:</strong> ${sectionTitle}</div>
            `;

        document.getElementById("previewImage").src = imageLink;
        document.getElementById("uploadModal").style.display = "block";

        // Reset form
        document.getElementById("userImageInput").value = "";
        document.getElementById("userImagePreview").style.display = "none";
        document.getElementById("captionInput").value = "";
        document.getElementById("statusMessage").innerHTML = "";
        document.getElementById("resultImage").style.display = "none";
        userImageFile = null;
        userImageBase64 = null;
      }

      // Handle file selection
      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        userImageFile = file;

        // Show preview
        const reader = new FileReader();
        reader.onload = (e) => {
          const preview = document.getElementById("userImagePreview");
          preview.src = e.target.result;
          preview.style.display = "block";

          // Store base64 (remove data:image/...;base64, prefix)
          userImageBase64 = e.target.result.split(",")[1];
        };
        reader.readAsDataURL(file);
      }

      // Authentication functions
      function createSignature(secretKey, timestamp) {
        const message = timestamp.toString();
        return CryptoJS.HmacSHA256(message, secretKey).toString(
          CryptoJS.enc.Base64
        );
      }

      async function getJWTToken() {
        const timestamp = Math.floor(Date.now() / 1000);
        const signature = createSignature(IMAGE3_SECRET_KEY, timestamp);

        const headers = {
          "X-API-Key": API_KEY,
          "X-Timestamp": timestamp.toString(),
          "X-Signature": signature,
          "Content-Type": "application/x-www-form-urlencoded",
        };

        const formData = new URLSearchParams();
        formData.append("grant_type", "password");
        formData.append("username", "test_user");
        formData.append("password", "test_password");

        const response = await fetch(`${API_URL}/token_image3`, {
          method: "POST",
          headers: headers,
          body: formData,
        });

        if (!response.ok) {
          throw new Error(`Failed to get JWT token: ${response.status}`);
        }

        const data = await response.json();
        return data.access_token;
      }

      function generateUUID() {
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
          /[xy]/g,
          function (c) {
            const r = (Math.random() * 16) | 0;
            const v = c === "x" ? r : (r & 0x3) | 0x8;
            return v.toString(16);
          }
        );
      }

      async function getAuthHeaders() {
        const timestamp = Math.floor(Date.now() / 1000);
        const signature = createSignature(IMAGE3_SECRET_KEY, timestamp);
        const token = await getJWTToken();
        const requestId = generateUUID();

        return {
          "X-API-Key": API_KEY,
          "X-Timestamp": timestamp.toString(),
          "X-Signature": signature,
          Authorization: `Bearer ${token}`,
          "X-Request-ID": requestId,
          "User-Agent": "WellyAPI-Web/1.0 (Image3)",
          Accept: "application/json",
        };
      }

      // Handle submit
      async function handleSubmit() {
        if (!userImageFile) {
          showStatus("Please select an image first", "error");
          return;
        }

        const caption = document.getElementById("captionInput").value.trim();
        if (!caption) {
          showStatus(
            "Please enter a caption describing the changes you want",
            "error"
          );
          return;
        }

        const submitBtn = document.getElementById("submitButton");
        submitBtn.disabled = true;
        showStatus("Processing... This may take up to 3 minutes", "loading");

        try {
          // Get auth headers
          const headers = await getAuthHeaders();

          // Prepare form data
          const formData = new FormData();
          formData.append("image", userImageFile);
          formData.append("caption", caption);
          formData.append("user_instruction", "");
          formData.append("template_id", selectedItem.id);
          formData.append("image_base64", userImageBase64);

          // Send request
          const response = await fetch(`${API_URL}/image3/edit_image`, {
            method: "POST",
            headers: headers,
            body: formData,
          });

          const result = await response.json();

          if (response.ok && result.success) {
            showStatus("‚úÖ Image generated successfully!", "success");

            // Display result image
            const resultImg = document.getElementById("resultImage");
            resultImg.src = `data:image/png;base64,${result.data[0].b64_json}`;
            resultImg.style.display = "block";

            // Download result
            downloadImage(
              result.data[0].b64_json,
              `result_${selectedItem.id}_${Date.now()}.png`
            );
          } else {
            const errorMsg = result.error
              ? `${result.error.code}: ${result.error.message}`
              : "Unknown error occurred";
            showStatus(`‚ùå Error: ${errorMsg}`, "error");
          }
        } catch (error) {
          showStatus(`‚ùå Error: ${error.message}`, "error");
        } finally {
          submitBtn.disabled = false;
        }
      }

      // Show status message
      function showStatus(message, type) {
        const statusDiv = document.getElementById("statusMessage");
        statusDiv.innerHTML = message;
        statusDiv.className = `status-message status-${type}`;
      }

      // Download image
      function downloadImage(base64Data, filename) {
        const link = document.createElement("a");
        link.href = `data:image/png;base64,${base64Data}`;
        link.download = filename;
        link.click();
      }
    </script>

    <!-- CryptoJS for HMAC-SHA256 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  </body>
</html>
